<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escanear QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #reader {
      width: 300px;
      margin: auto;
    }
    button {
      margin-top: 15px;
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>

<body>

  <h2>Escanear QR</h2>

  <!-- üî¢ CONTADOR -->
  <h3 style="color:red;font-size:22px">
  Personas registradas: <span id="contador">0</span>
</h3>

  <div id="reader"></div>
  <button onclick="startScanner()">Iniciar con c√°mara trasera</button>

  <h3>Datos del evento</h3>

  <label>Nombre del evento:</label><br>
  <input type="text" id="evento" placeholder="Ej. Conferencia 2026"><br><br>

  <label>Fecha del evento:</label><br>
  <input type="date" id="fecha"><br><br>

  <script>
    const html5QrCode = new Html5Qrcode("reader");

    // üì∏ ESC√ÅNER
    async function startScanner() {
      const devices = await Html5Qrcode.getCameras();

      if (devices && devices.length) {
        const backCamera =
          devices.find(d =>
            d.label.toLowerCase().includes("back") ||
            d.label.toLowerCase().includes("rear") ||
            d.label.toLowerCase().includes("trasera")
          ) || devices[devices.length - 1];

        html5QrCode.start(
          backCamera.id,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            const evento = document.getElementById("evento").value;
            const fecha = document.getElementById("fecha").value;

            if (!evento || !fecha) {
              alert("Primero escribe el evento y la fecha");
              return;
            }

            const url =
              "https://script.google.com/macros/s/AKfycbzYJS1vYQ9ewr__4PjlB7gi6IcLJO7fT6mZb4j2XZWsDidJOVoPHrS3g-G-edlbU9j_/exec" +
              "?matricula=" + encodeURIComponent(qrCodeMessage) +
              "&evento=" + encodeURIComponent(evento) +
              "&fecha=" + encodeURIComponent(fecha);

            fetch(url)
              .then(res => res.text())
              .then(txt => {
                alert(txt);
                actualizarContador(); // üîÑ actualizar al registrar
              })
              .catch(() => {
                alert("Error al registrar");
              });

            html5QrCode.stop();
          }
        );
      } else {
        alert("No se encontraron c√°maras");
      }
    }

    // üî¢ CONTADOR EN TIEMPO REAL
    function actualizarContador() {
      fetch("https://script.google.com/macros/s/AKfycbzYJS1vYQ9ewr__4PjlB7gi6IcLJO7fT6mZb4j2XZWsDidJOVoPHrS3g-G-edlbU9j_/exec?contador=true")
        .then(res => res.text())
        .then(total => {
          document.getElementById("contador").innerText = total;
        })
        .catch(err => {
          console.log("Error al obtener contador", err);
        });
    }

    // ‚è±Ô∏è ACTUALIZACI√ìN AUTOM√ÅTICA
    actualizarContador();
    setInterval(actualizarContador, 3000);
  </script>

</body>
</html>














